pipeline {
    agent any

    parameters {
        // Changed to HTTPS URL to work with 'github-token'
        string(name: 'APP_REPO', defaultValue: 'https://github.com/princemaxi/php-todo.git', description: 'App repo to build')
        string(name: 'APP_BRANCH', defaultValue: 'main', description: 'Branch to build')
        choice(name: 'inventory', choices: ['ci','dev','pentest'], description: 'Target inventory to use (folder under ansible/inventories)')
        string(name: 'ansible_tags', defaultValue: '', description: 'Optional Ansible tags (comma separated)')
    }

    environment {
        // --- Configuration ---
        // 1. SonarQube Token (matches your credentials)
        SONAR_TOKEN = credentials('sonarqube-token')
        // 2. SonarQube Host (FIX: Updated to your new public IP)
        SONAR_HOST = "http://13.40.142.176:9000"
        // 3. Artifactory Host (using your cloud URL)
        ARTIFACTORY_HOST = "https://princemaxi.jfrog.io"
    }

    stages {
        stage('Checkout Infra (Ansible)') {
            steps {
                // Checks out the Ansible configuration from *this* repository
                checkout scm
            }
        }

        stage('Checkout App (PHP)') {
            steps {
                dir('todo-app') {
                    // Checks out the PHP app using your 'github-token'
                    git credentialsId: 'github-token', url: params.APP_REPO, branch: params.APP_BRANCH
                    script {
                        // Grabs the Git commit ID to use as a version
                        env.GIT_COMMIT = sh(returnStdout: true, script: 'git rev-parse --short HEAD').trim()
                    }
                }
            }
        }

        stage('Build / Package') {
            steps {
                dir('todo-app') {
                    sh '''
                        set -e
                        rm -rf dist || true
                        mkdir -p dist

                        # Use rsync to copy app files from root (.) to dist/, excluding .git
                        rsync -av --progress . dist/ --exclude .git

                        # Creates the tarball for upload
                        tar -czf ../todo-app-${GIT_COMMIT}-${BUILD_NUMBER}.tar.gz -C dist .
                    '''
                }
                // Saves the artifact in Jenkins for review
                archiveArtifacts artifacts: "todo-app-${GIT_COMMIT}-${BUILD_NUMBER}.tar.gz", fingerprint: true
            }
        }

        stage('SonarQube Analysis') {
            when {
                anyOf {
                    branch 'main'
                    branch 'develop'
                }
            }
            steps {
                dir('todo-app') {
                    sh '''
                        echo "--- Running SonarQube Analysis ---"
                        echo "Current directory:"
                        pwd
                        echo "Directory contents:"
                        ls -la

                        /opt/sonar-scanner/bin/sonar-scanner \
                          -Dsonar.projectKey=php-todo \
                          -Dsonar.sources=. \
                          -Dsonar.exclusions=dist/** \
                          -Dsonar.javascript.exclusions=**/* \
                          -Dsonar.css.exclusions=**/* \
                          -Dsonar.typescript.exclusions=**/* \
                          -Dsonar.host.url=$SONAR_HOST \
                          -Dsonar.login=$SONAR_TOKEN
                    '''
                }
            }
        }


        stage('Upload artifact to Artifactory') {
            steps {
                // Securely loads your 'artifactory-token'
                withCredentials([usernamePassword(credentialsId: 'artifactory-token', usernameVariable: 'ART_USER', passwordVariable: 'ART_PASS')]) {
                    sh """
                        # Sets the path using your correct repository 'php-todo-repo'
                        ART_PATH="php-todo-repo/todo-app/${GIT_COMMIT}/${BUILD_NUMBER}/todo-app-${GIT_COMMIT}-${BUILD_NUMBER}.tar.gz"

                        # *** FIX: Escaped \$ART_PATH ***
                        # Uploads the file using your cloud URL and credentials
                        curl -u ${ART_USER}:${ART_PASS} -T todo-app-${GIT_COMMIT}-${BUILD_NUMBER}.tar.gz "${ARTIFACTORY_HOST}/artifactory/\${ART_PATH}"

                        # *** FIX: Escaped \$ART_PATH ***
                        echo "ARTIFACT_PATH=${ARTIFACTORY_HOST}/artifactory/\${ART_PATH}" > artifact-info.txt
                    """
                }
                archiveArtifacts artifacts: 'artifact-info.txt'
            }
        }

        stage('Deploy via Ansible') {
            steps {
                // Securely loads your 'ansible-ssh' private key
                withCredentials([sshUserPrivateKey(credentialsId: 'ansible-ssh', keyFileVariable: 'ANSIBLE_KEY')]) {
                    sh """
                        export ANSIBLE_CONFIG=${WORKSPACE}/ansible/ansible.cfg

                        # Removed '-u' so Ansible uses the user defined in your inventory files
                        ansible-playbook -i ansible/inventories/${inventory}/hosts.ini ansible/playbooks/deploy_from_artifactory.yml \
                          --private-key=${ANSIBLE_KEY} \
                          --extra-vars "build_number=${BUILD_NUMBER} commit_hash=${GIT_COMMIT} target_group=todo" \
                          --extra-vars "artifactory_base=${ARTIFACTORY_HOST}/artifactory/php-todo-repo"
                    """
                }
            }
        }
    }

    post {
        always {
            cleanWs()
        }
    }
}
